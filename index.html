<!DOCTYPE html>
<html>
<head>
    <title>GC Bug Demonstration</title>
</head>
<body>
<script>
(function() {
    const iterations = 500; // Increased iterations for greater effect
    const objectCount = 5000000; // Increased object count
    let globalArray = [];

    function createObjects() {
        let objects = [];
        for (let i = 0; i < objectCount; i++) {
            let obj = { id: i };
            if (i > 0) {
                obj.incoming = objects[i - 1];
            }
            objects.push(obj);
        }
        return objects;
    }

    function breakReferences(objects) {
        for (let obj of objects) {
            delete obj.incoming;
        }
    }

    function runTest() {
        console.log('Test started.');
        for (let i = 0; i < iterations; i++) {
            console.log(`Iteration ${i + 1} started`);

            // Create objects with incoming references
            let objects = createObjects();

            // Optionally retain a reference to some objects to prevent immediate GC
            globalArray.push(objects.slice(0, 100));

            // Break the incoming references
            breakReferences(objects);

            // Remove references to allow garbage collection
            objects = null;

            // Encourage garbage collection
            setTimeout(() => {
                globalArray.shift(); // Remove retained references
            }, 500);

            // Log memory usage after a delay
            setTimeout(() => {
                if (window.performance && window.performance.memory) {
                    console.log(`Memory used: ${(performance.memory.usedJSHeapSize / 1048576).toFixed(2)} MB`);
                } else {
                    console.log('Memory usage information is not available in this browser.');
                }
            }, 100);

            console.log(`Iteration ${i + 1} completed`);
        }
        console.log('Test completed.');
    }

    // Start the test after a short delay
    setTimeout(runTest, 1000);
})();
</script>
</body>
</html>
